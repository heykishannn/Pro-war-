<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro War - Real Money Gaming</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        :root {
            --gold: #FFD700;
            --dark-gold: #C5A30B;
            --glass-bg: rgba(255, 215, 0, 0.15);
            --glass-border: rgba(255, 215, 0, 0.3);
            --glass-shadow: 0 8px 32px rgba(255, 215, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            color: white;
            min-height: 100vh;
        }

        /* Glassmorphism Effect */
        .glass-card {
            background: var(--glass-bg);
            border-radius: 16px;
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        /* Splash Screen - UPDATED */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeOut 0.5s ease-in-out 2.5s forwards; /* Fades out after 2.5s */
        }

        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }

        .logo {
            font-size: 3.5rem;
            font-weight: bold;
            background: linear-gradient(to right, var(--gold), var(--dark-gold));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); /* Removed glow, added subtle shadow */
            animation: logo-intro 1.5s ease-out forwards; /* New intro animation */
        }

        @keyframes logo-intro {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            60% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Auth Screens */
        .auth-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 16px;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--gold);
            font-size: 1.8rem;
        }

        .auth-form input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 1rem;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(to right, var(--gold), var(--dark-gold));
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1rem;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1rem;
            color: #aaa;
        }

        .auth-toggle span {
            color: var(--gold);
            cursor: pointer;
            text-decoration: underline;
        }

        .error-message {
            color: #ff6b6b; /* Default to red for errors */
            font-size: 0.9rem;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }

        /* Main App */
        #app-container {
            display: none;
            padding: 1rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .app-logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--gold);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .wallet-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: var(--gold);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
        }

        /* Banner */
        .swiper {
            width: 100%;
            height: 180px;
            margin-bottom: 2rem;
        }

        .swiper-slide {
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 16px;
            overflow: hidden;
        }

        .banner-card {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1rem;
        }

        .banner-card h3 {
            color: white;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
        }

        .banner-card p {
            color: #ddd;
            font-size: 0.9rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* Sections */
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--gold);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title a {
            font-size: 0.9rem;
            color: #aaa;
            text-decoration: none;
        }

        /* Tournaments */
        .tournaments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tournament-card {
            padding: 1rem;
            position: relative;
        }

        .tournament-card h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .tournament-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .tournament-details div {
            display: flex;
            flex-direction: column;
        }

        .tournament-details span:first-child {
            font-size: 0.8rem;
            color: #aaa;
        }

        .tournament-details span:last-child {
            font-size: 1rem;
            color: var(--gold);
            font-weight: bold;
        }

        .join-btn {
            width: 100%;
            padding: 8px;
            background: linear-gradient(to right, var(--gold), var(--dark-gold));
            border: none;
            border-radius: 8px;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
        }

        /* Mini Games */
        .games-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .game-card {
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .game-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .game-card h3 {
            font-size: 1rem;
            text-align: center;
        }

        /* Game Modal */
        .game-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1001;
            flex-direction: column;
        }

        .game-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-title {
            color: var(--gold);
            font-size: 1.2rem;
        }

        .close-game {
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .game-frame {
            flex: 1;
            width: 100%;
            border: none;
        }

        /* Wallet Modal */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .wallet-box {
            width: 90%;
            max-width: 400px;
            padding: 1.5rem;
        }

        .wallet-balance {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .wallet-balance h3 {
            color: #aaa;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .wallet-balance p {
            font-size: 2rem;
            color: var(--gold);
            font-weight: bold;
        }

        .wallet-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .wallet-btn-action {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }

        .add-money {
            background: linear-gradient(to right, var(--gold), var(--dark-gold));
            color: #1a1a1a;
        }

        .withdraw {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid var(--glass-border);
        }

        .wallet-history h3 {
            color: #aaa;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transaction-amount {
            font-weight: bold;
        }

        .credit {
            color: #4CAF50;
        }

        .debit {
            color: #F44336;
        }

        /* Payment Modal */
        .payment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .payment-box {
            width: 90%;
            max-width: 400px;
            padding: 1.5rem;
        }

        .payment-title {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--gold);
            font-size: 1.3rem;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payment-option {
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--glass-border);
            text-align: center;
            cursor: pointer;
        }

        .payment-option.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: var(--gold);
        }

        .payment-option span {
            display: block;
            font-weight: bold;
            margin-top: 5px;
        }

        .custom-amount {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 1rem;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .proceed-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(to right, var(--gold), var(--dark-gold));
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tournaments-grid {
                grid-template-columns: 1fr;
            }
            
            .logo {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="logo">PRO WAR</div>
    </div>

    <!-- Auth Screens -->
    <div id="login-container" class="auth-container">
        <div class="auth-box glass-card">
            <h2 class="auth-title">Login</h2>
            <form id="login-form" class="auth-form">
                <div id="login-error" class="error-message"></div>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="auth-btn">Login</button>
            </form>
            <div id="forgot-password" style="text-align: right; margin-top: -0.5rem;">
                <a href="#" id="forgot-link" style="color: #aaa; font-size: 0.9rem;">Forgot Password?</a>
            </div>
            <div class="auth-toggle">
                Don't have an account? <span id="show-signup">Sign Up</span>
            </div>
        </div>
    </div>

    <div id="signup-container" class="auth-container">
        <div class="auth-box glass-card">
            <h2 class="auth-title">Sign Up</h2>
            <form id="signup-form" class="auth-form">
                <div id="signup-error" class="error-message"></div>
                <input type="text" id="signup-username" placeholder="Username" required>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit" class="auth-btn">Sign Up</button>
            </form>
            <div class="auth-toggle">
                Already have an account? <span id="show-login">Login</span>
            </div>
        </div>
    </div>

    <div id="forgot-container" class="auth-container">
        <div class="auth-box glass-card">
            <h2 class="auth-title">Reset Password</h2>
            <form id="forgot-form" class="auth-form">
                <div id="forgot-error" class="error-message"></div>
                <input type="email" id="forgot-email" placeholder="Email" required>
                <button type="submit" class="auth-btn">Send Reset Link</button>
            </form>
            <div class="auth-toggle">
                Remember your password? <span id="show-login-from-forgot">Login</span>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container">
        <header>
            <div class="app-logo">PRO WAR</div>
            <div class="user-menu">
                <button id="wallet-btn" class="wallet-btn">
                    <span id="wallet-amount">₹0</span>
                </button>
                <div id="profile-btn" class="profile-pic">U</div>
            </div>
        </header>

        <main>
            <!-- Banner Slider -->
            <div class="swiper">
                <div class="swiper-wrapper">
                    <div class="swiper-slide">
                        <div class="banner-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://via.placeholder.com/600x400?text=Win+Big+Today')">
                            <h3>Daily Jackpot</h3>
                            <p>Play now to win up to ₹50,000</p>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="banner-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://via.placeholder.com/600x400?text=New+Tournaments')">
                            <h3>New Tournaments</h3>
                            <p>Join exclusive competitions</p>
                        </div>
                    </div>
                    <div class="swiper-slide">
                        <div class="banner-card" style="background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://via.placeholder.com/600x400?text=Refer+and+Earn')">
                            <h3>Refer & Earn</h3>
                            <p>Get ₹100 for each friend</p>
                        </div>
                    </div>
                </div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- Live Tournaments -->
            <section>
                <h3 class="section-title">
                    Live Tournaments
                    <a href="#">View All</a>
                </h3>
                <div id="tournaments-container" class="tournaments-grid">
                    <!-- Filled by JavaScript -->
                </div>
            </section>

            <!-- Mini Games -->
            <section>
                <h3 class="section-title">Featured Games</h3>
                <div class="games-grid">
                    <div id="ludo-game" class="game-card glass-card">
                        <div class="game-icon">🎲</div>
                        <h3>Ludo King</h3>
                    </div>
                    <div id="mines-game" class="game-card glass-card">
                        <div class="game-icon">💣</div>
                        <h3>Mines</h3>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Game Modal -->
    <div id="game-modal" class="game-modal">
        <div class="game-header">
            <div class="game-title" id="current-game-title">Game</div>
            <div class="close-game" id="close-game">&times;</div>
        </div>
        <iframe id="game-frame" class="game-frame" src="" frameborder="0"></iframe>
    </div>

    <!-- Wallet Modal -->
    <div id="wallet-modal" class="wallet-modal">
        <div class="wallet-box glass-card">
            <div class="wallet-balance">
                <h3>Wallet Balance</h3>
                <p id="modal-wallet-amount">₹0</p>
            </div>
            <div class="wallet-actions">
                <button id="add-money-btn" class="wallet-btn-action add-money">Add Money</button>
                <button id="withdraw-btn" class="wallet-btn-action withdraw">Withdraw</button>
            </div>
            <div class="wallet-history">
                <h3>Transaction History</h3>
                <div id="transactions-list">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
            <button id="close-wallet" style="margin-top: 1.5rem; width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white; border-radius: 8px; cursor: pointer;">
                Close
            </button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="payment-modal">
        <div class="wallet-box glass-card">
            <h3 class="payment-title">Add Money to Wallet</h3>
            <div class="payment-options">
                <div class="payment-option" data-amount="100">
                    ₹100
                </div>
                <div class="payment-option" data-amount="300">
                    ₹300
                </div>
                <div class="payment-option" data-amount="500">
                    ₹500
                </div>
                <div class="payment-option" data-amount="1000">
                    ₹1000
                </div>
            </div>
            <input type="number" id="custom-amount" class="custom-amount" placeholder="Enter custom amount">
            <button id="proceed-payment" class="proceed-btn">Proceed to Pay</button>
            <button id="close-payment" style="margin-top: 1rem; width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white; border-radius: 8px; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdraw-modal" class="payment-modal">
        <div class="wallet-box glass-card">
            <h3 class="payment-title">Withdraw Money</h3>
            <input type="number" id="withdraw-amount" class="custom-amount" placeholder="Enter amount to withdraw">
            <input type="text" id="upi-id" class="custom-amount" placeholder="Enter UPI ID" style="margin-top: 1rem;">
            <button id="proceed-withdraw" class="proceed-btn">Request Withdrawal</button>
            <button id="close-withdraw" style="margin-top: 1rem; width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white; border-radius: 8px; cursor: pointer;">
                Cancel
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://udzedfjohdvdbuqszpsb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkemVkZmpvaGR2ZGJ1cXN6cHNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1MTk4OTYsImV4cCI6MjA2NzA5NTg5Nn0.XXqF4YUS_56lxv7CesmlnfdXeEUZp1bp1y1EKpQY7q8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // DOM Elements
        const splashScreen = document.getElementById('splash-screen');
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const forgotContainer = document.getElementById('forgot-container');
        const appContainer = document.getElementById('app-container');
        const walletAmount = document.getElementById('wallet-amount');
        const modalWalletAmount = document.getElementById('modal-wallet-amount');
        const tournamentsContainer = document.getElementById('tournaments-container');
        const transactionsList = document.getElementById('transactions-list');
        const walletModal = document.getElementById('wallet-modal');
        const paymentModal = document.getElementById('payment-modal');
        const withdrawModal = document.getElementById('withdraw-modal');
        const gameModal = document.getElementById('game-modal');
        const gameFrame = document.getElementById('game-frame');
        const currentGameTitle = document.getElementById('current-game-title');

        // Auth Elements
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotForm = document.getElementById('forgot-form');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const forgotError = document.getElementById('forgot-error');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const showLoginFromForgot = document.getElementById('show-login-from-forgot');
        const forgotLink = document.getElementById('forgot-link');

        // Game Elements
        const ludoGame = document.getElementById('ludo-game');
        const minesGame = document.getElementById('mines-game');
        const closeGame = document.getElementById('close-game');

        // Wallet Elements
        const walletBtn = document.getElementById('wallet-btn');
        const addMoneyBtn = document.getElementById('add-money-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const closeWallet = document.getElementById('close-wallet');
        const paymentOptions = document.querySelectorAll('.payment-option');
        const proceedPayment = document.getElementById('proceed-payment');
        const customAmount = document.getElementById('custom-amount');
        const closePayment = document.getElementById('close-payment');
        const proceedWithdraw = document.getElementById('proceed-withdraw');
        const withdrawAmount = document.getElementById('withdraw-amount');
        const upiId = document.getElementById('upi-id');
        const closeWithdraw = document.getElementById('close-withdraw');

        // State
        let currentUser = null;
        let selectedAmount = 0;
        let loginAttempts = 0;

        // Initialize Swiper
        const swiper = new Swiper('.swiper', {
            loop: true,
            autoplay: {
                delay: 3000,
            },
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
        });

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkAuth();
            }, 3000); // Wait for splash screen to finish
        });

        // Auth Event Listeners
        showSignup.addEventListener('click', () => {
            loginContainer.style.display = 'none';
            signupContainer.style.display = 'flex';
            loginError.textContent = '';
        });

        showLogin.addEventListener('click', () => {
            signupContainer.style.display = 'none';
            loginContainer.style.display = 'flex';
            signupError.textContent = '';
        });

        showLoginFromForgot.addEventListener('click', () => {
            forgotContainer.style.display = 'none';
            loginContainer.style.display = 'flex';
            forgotError.textContent = '';
        });

        forgotLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginContainer.style.display = 'none';
            forgotContainer.style.display = 'flex';
            loginError.textContent = '';
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                loginAttempts++;
                if (loginAttempts >= 3) {
                    forgotLink.style.display = 'block';
                }
                loginError.textContent = error.message;
                return;
            }

            currentUser = data.user;
            await fetchUserProfile();
        });

        // UPDATED SIGNUP FORM EVENT LISTENER
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const username = document.getElementById('signup-username').value;

            // First sign up with email and password
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email,
                password
            });

            if (authError) {
                signupError.style.color = '#ff6b6b'; // Red for error
                signupError.textContent = authError.message;
                return;
            }

            // Then create a profile in the profiles table
            const { user } = authData;
            const { error: insertError } = await supabase.from("profiles").insert({
                id: user.id,
                username: username,
                email: email, // Storing email in profile as well
                is_admin: false,
                is_owner: false,
                wallet_balance: 0
            });

            if (insertError) {
                signupError.style.color = '#ff6b6b'; // Red for error
                signupError.textContent = insertError.message;
                return;
            }

            // Show success message in green
            signupError.style.color = '#4CAF50';
            signupError.textContent = "Signup successful! Please check your email to verify.";

            // Clear form
            document.getElementById('signup-username').value = '';
            document.getElementById('signup-email').value = '';
            document.getElementById('signup-password').value = '';

            // Redirect to login page after a delay
            setTimeout(() => {
                signupContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
                signupError.textContent = ''; // Clear message
                signupError.style.color = '#ff6b6b'; // Reset color for future errors
            }, 3000);
        });

        forgotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            
            const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: 'https://udzedfjohdvdbuqszpsb.supabase.co/auth/reset-password'
            });

            if (error) {
                forgotError.textContent = error.message;
                return;
            }

            forgotError.textContent = '';
            forgotError.style.color = '#4CAF50';
            forgotError.textContent = 'Password reset link sent to your email!';
            
            // Clear form
            document.getElementById('forgot-email').value = '';
            
            // Show login after 3 seconds
            setTimeout(() => {
                forgotContainer.style.display = 'none';
                loginContainer.style.display = 'flex';
                forgotError.textContent = '';
                forgotError.style.color = '#ff6b6b';
            }, 3000);
        });

        // Game Event Listeners
        ludoGame.addEventListener('click', () => {
            openGame('Ludo King', 'https://ludo-king-game.vercel.app/');
        });

        minesGame.addEventListener('click', () => {
            openGame('Mines', 'https://mines-game-html.vercel.app/');
        });

        closeGame.addEventListener('click', () => {
            gameModal.style.display = 'none';
            gameFrame.src = '';
        });

        // Wallet Event Listeners
        walletBtn.addEventListener('click', () => {
            walletModal.style.display = 'flex';
            fetchTransactions();
        });

        closeWallet.addEventListener('click', () => {
            walletModal.style.display = 'none';
        });

        addMoneyBtn.addEventListener('click', () => {
            walletModal.style.display = 'none';
            paymentModal.style.display = 'flex';
            selectedAmount = 0;
            customAmount.value = '';
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('active');
            });
        });

        withdrawBtn.addEventListener('click', () => {
            walletModal.style.display = 'none';
            withdrawModal.style.display = 'flex';
            withdrawAmount.value = '';
            upiId.value = '';
        });

        paymentOptions.forEach(option => {
            option.addEventListener('click', () => {
                selectedAmount = parseInt(option.dataset.amount);
                customAmount.value = '';
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                option.classList.add('active');
            });
        });

        customAmount.addEventListener('input', () => {
            if (customAmount.value) {
                selectedAmount = parseInt(customAmount.value);
                document.querySelectorAll('.payment-option').forEach(option => {
                    option.classList.remove('active');
                });
            }
        });

        proceedPayment.addEventListener('click', async () => {
            if (!selectedAmount || selectedAmount < 10) {
                alert('Please select a valid amount (minimum ₹10)');
                return;
            }

            // Create a Razorpay order
            const options = {
                key: 'rzp_test_1DP5mmOlF5G5ag', // Test key - replace with your actual key
                amount: selectedAmount * 100, // Razorpay expects amount in paise
                currency: 'INR',
                name: 'Pro War',
                description: 'Add Money to Wallet',
                image: 'https://via.placeholder.com/150?text=Pro+War',
                handler: async function(response) {
                    // Payment successful - update wallet balance
                    const { data: userData, error: userError } = await supabase
                        .from('profiles')
                        .select('wallet_balance')
                        .eq('id', currentUser.id)
                        .single();

                    if (userError) {
                        console.error('Error fetching wallet balance:', userError);
                        return;
                    }

                    const newBalance = userData.wallet_balance + selectedAmount;

                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ wallet_balance: newBalance })
                        .eq('id', currentUser.id);

                    if (updateError) {
                        console.error('Error updating wallet balance:', updateError);
                        return;
                    }

                    // Record transaction
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert([
                            { 
                                user_id: currentUser.id,
                                amount: selectedAmount,
                                type: 'credit',
                                description: 'Wallet top-up via Razorpay',
                                status: 'completed'
                            }
                        ]);

                    if (transactionError) {
                        console.error('Error recording transaction:', transactionError);
                    }

                    // Update UI
                    walletAmount.textContent = `₹${newBalance}`;
                    modalWalletAmount.textContent = `₹${newBalance}`;
                    paymentModal.style.display = 'none';
                    walletModal.style.display = 'flex';
                    fetchTransactions();
                },
                prefill: {
                    name: currentUser?.email || '',
                    email: currentUser?.email || ''
                },
                theme: {
                    color: '#FFD700'
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        });

        closePayment.addEventListener('click', () => {
            paymentModal.style.display = 'none';
            walletModal.style.display = 'flex';
        });

        proceedWithdraw.addEventListener('click', async () => {
            const amount = parseInt(withdrawAmount.value);
            const upi = upiId.value.trim();

            if (!amount || amount < 100) {
                alert('Minimum withdrawal amount is ₹100');
                return;
            }

            if (!upi || !upi.includes('@')) {
                alert('Please enter a valid UPI ID');
                return;
            }

            // Check if user has sufficient balance
            const { data: userData, error: userError } = await supabase
                .from('profiles')
                .select('wallet_balance')
                .eq('id', currentUser.id)
                .single();

            if (userError) {
                console.error('Error fetching wallet balance:', userError);
                return;
            }

            if (userData.wallet_balance < amount) {
                alert('Insufficient balance for withdrawal');
                return;
            }

            // In a real app, you would call Cashfree Payout API here
            // For demo, we'll simulate a successful withdrawal
            
            // Deduct from wallet
            const newBalance = userData.wallet_balance - amount;

            const { error: updateError } = await supabase
                .from('profiles')
                .update({ wallet_balance: newBalance })
                .eq('id', currentUser.id);

            if (updateError) {
                console.error('Error updating wallet balance:', updateError);
                return;
            }

            // Record transaction
            const { error: transactionError } = await supabase
                .from('transactions')
                .insert([
                    { 
                        user_id: currentUser.id,
                        amount: amount,
                        type: 'debit',
                        description: `Withdrawal to ${upi}`,
                        status: 'pending' // Would be 'completed' after Cashfree processes it
                    }
                ]);

            if (transactionError) {
                console.error('Error recording transaction:', transactionError);
            }

            // Update UI
            walletAmount.textContent = `₹${newBalance}`;
            modalWalletAmount.textContent = `₹${newBalance}`;
            withdrawModal.style.display = 'none';
            walletModal.style.display = 'flex';
            fetchTransactions();

            alert(`Withdrawal request of ₹${amount} to ${upi} has been submitted. It will be processed within 24 hours.`);
        });

        closeWithdraw.addEventListener('click', () => {
            withdrawModal.style.display = 'none';
            walletModal.style.display = 'flex';
        });

        // Functions
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (user) {
                currentUser = user;
                await fetchUserProfile();
            } else {
                showAuthScreen();
            }
        }

        function showAuthScreen() {
            splashScreen.style.display = 'none';
            loginContainer.style.display = 'flex';
        }

        async function fetchUserProfile() {
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (error) {
                console.error('Error fetching profile:', error);
                // This could happen if a user signs up but the profile creation fails.
                // We should probably log them out or show an error.
                // For now, we'll just log it and prevent the app from loading.
                supabase.auth.signOut();
                showAuthScreen();
                return;
            }

            // Update wallet display
            walletAmount.textContent = `₹${data.wallet_balance}`;
            modalWalletAmount.textContent = `₹${data.wallet_balance}`;

            // Update profile initial
            const profileBtn = document.getElementById('profile-btn');
            profileBtn.textContent = data.username.charAt(0).toUpperCase();

            // Show appropriate screen based on role
            splashScreen.style.display = 'none';
            loginContainer.style.display = 'none';
            signupContainer.style.display = 'none';
            forgotContainer.style.display = 'none';
            appContainer.style.display = 'block';

            // For demo, we're just showing user.html regardless of role
            // In a real app, you would redirect to owner.html or admin.html if those roles are true
            fetchTournaments();
        }

        async function fetchTournaments() {
            const { data, error } = await supabase
                .from('tournaments')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            if (error) {
                console.error('Error fetching tournaments:', error);
                return;
            }

            tournamentsContainer.innerHTML = '';
            data.forEach(tournament => {
                const card = document.createElement('div');
                card.className = 'tournament-card glass-card';
                card.innerHTML = `
                    <h3>${tournament.name}</h3>
                    <div class="tournament-details">
                        <div>
                            <span>Entry Fee</span>
                            <span>₹${tournament.entry_fee}</span>
                        </div>
                        <div>
                            <span>Prize Pool</span>
                            <span>₹${tournament.prize_pool}</span>
                        </div>
                    </div>
                    <button class="join-btn" data-id="${tournament.id}" data-fee="${tournament.entry_fee}">Join Now</button>
                `;
                tournamentsContainer.appendChild(card);
            });

            // Add event listeners to join buttons
            document.querySelectorAll('.join-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const tournamentId = e.target.dataset.id;
                    const entryFee = parseInt(e.target.dataset.fee);
                    
                    // Check if user has sufficient balance
                    const { data: userData, error: userError } = await supabase
                        .from('profiles')
                        .select('wallet_balance')
                        .eq('id', currentUser.id)
                        .single();

                    if (userError) {
                        console.error('Error fetching wallet balance:', userError);
                        return;
                    }

                    if (userData.wallet_balance < entryFee) {
                        alert('Insufficient balance to join this tournament');
                        walletModal.style.display = 'flex';
                        return;
                    }

                    // Deduct entry fee
                    const newBalance = userData.wallet_balance - entryFee;

                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ wallet_balance: newBalance })
                        .eq('id', currentUser.id);

                    if (updateError) {
                        console.error('Error updating wallet balance:', updateError);
                        return;
                    }

                    // Record transaction
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert([
                            { 
                                user_id: currentUser.id,
                                amount: entryFee,
                                type: 'debit',
                                description: `Tournament entry: ${e.target.parentElement.querySelector('h3').textContent}`,
                                status: 'completed'
                            }
                        ]);

                    if (transactionError) {
                        console.error('Error recording transaction:', transactionError);
                    }

                    // Update UI
                    walletAmount.textContent = `₹${newBalance}`;
                    modalWalletAmount.textContent = `₹${newBalance}`;
                    fetchTransactions();

                    alert(`You have successfully joined the tournament! Entry fee of ₹${entryFee} has been deducted from your wallet.`);
                });
            });
        }

        async function fetchTransactions() {
            const { data, error } = await supabase
                .from('transactions')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false })
                .limit(10);

            if (error) {
                console.error('Error fetching transactions:', error);
                return;
            }

            transactionsList.innerHTML = '';
            if (data.length === 0) {
                transactionsList.innerHTML = `<div style="text-align: center; color: #aaa; padding: 1rem 0;">No transactions yet.</div>`;
                return;
            }
            data.forEach(transaction => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div>
                        <div>${transaction.description}</div>
                        <div style="font-size: 0.8rem; color: #aaa;">${new Date(transaction.created_at).toLocaleString()}</div>
                    </div>
                    <div class="transaction-amount ${transaction.type === 'credit' ? 'credit' : 'debit'}">
                        ${transaction.type === 'credit' ? '+' : '-'}₹${transaction.amount}
                    </div>
                `;
                transactionsList.appendChild(item);
            });
        }

        function openGame(title, url) {
            currentGameTitle.textContent = title;
            gameFrame.src = url;
            gameModal.style.display = 'flex';
        }
    </script>
</body>
</html>